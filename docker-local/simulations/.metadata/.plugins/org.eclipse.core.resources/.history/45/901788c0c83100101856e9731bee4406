/*
 * CentralUserConfig.cc
 *
 *  Created on: May 5, 2025
 *      Author: root
 */

#include "CentralUserConfig.h"
#include "inet/applications/base/ApplicationPacket_m.h"
#include "inet/applications/udpapp/SimpleUdpSinkApp.h"
namespace inet{

Define_Module(CentralUserConfig);


void CentralUserConfig::initialize()
{
}

void CentralUserConfig::handleMessage(cMessage *msg)
{
    if(msg->getKind() == MSGKIND_SEND_TA){
        std::cout << "\tHere the "<< this->getFullName() << " received stream request"<< endl;
        string sid = msg->par("sid").str();

        // topology mapping at controller side
        string talker = msg->par("talker").str();
        string  listener = msg->par("listener").str();

        int service_type = stoi(msg->par("service_type").stringValue()) ; // might be dcided by the controller

        float max_data = msg->par("max_data").doubleValue();
        float max_latency= msg->par("max_latency").doubleValue();

        StreamRegistrationRequest req = StreamRegistrationRequest(sid,  1,  1, service_type, max_data, max_latency);
        cout<<"Stream "<<req.sid<<" from "<<req.talker<<" to "<<req.listener<<" in mdr "<<req.max_data<<endl;

        CentralNetworkConfig *cnc = check_and_cast<CentralNetworkConfig *>((this->getParentModule())->getSubmodule("cnc"));
        cnc->registerStream(req);

        delete msg;
    }
}

void CentralUserConfig::informTalker(StreamStatus s){

    cPacket *packet = new cPacket("data");
    packet->setKind(MSGKIND_STREAM_RESPONSE);

    packet->addPar("sid"); //todo of cuc
    packet->par("sid").setStringValue((s.sid).c_str());

    packet->addPar("status");
    packet->par("status").setBoolValue(s.status);

    packet->addPar("offset");
    packet->par("offset").setDoubleValue(s.talkerOffset);

    cout<<"Talker Update: Stream "<< s.sid<<" status:"<<s.status<<" offset:"<<s.talkerOffset<<endl;

    cModule *targetDev =  this->getParentModule()->getParentModule()->getSubmodule("device1");
    cModule *appModule = targetDev->getSubmodule("app", 0)->getSubmodule("source");

    sendDirect(packet,  appModule->gate("fromCuc"));
    cout<<"Talker is informed by the CUC"<<endl;

}


}



